<!--
SPDX-License-Identifier: LicenseRef-ELI-1.0
Copyright (C) 2026 Julian Coccia. Released under the Elicitor's Code License 1.0 found in the LICENSE file.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Offline Family Tree</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: #f8f8f8;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 20px;
      flex: 1;
    }

    .header-btn {
      background: none;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      border-radius: 4px;
    }

    .header-btn:hover {
      background: #e0e0e0;
    }

    /* Main content */
    .main-content {
      display: block;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Person title */
    .person-title {
      font-size: 28px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    /* Row labels */
    .row-label {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin: 10px 0 5px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Card rows */
    .row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin: 0 -8px 15px -8px;
    }

    /* Person card */
    .card {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 140px;
      min-height: 180px;
      background: white;
      border-radius: 12px;
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
      margin: 8px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .card.focused {
      border: 3px solid #FF9800;
      background: #FFF3E0;
    }

    /* Avatar */
    .avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }

    .avatar.male { background-color: #64B5F6; }
    .avatar.female { background-color: #F48FB1; }
    .avatar.other { background-color: #90A4AE; }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .name {
      font-size: 13px;
      font-weight: bold;
      margin-bottom: 4px;
      word-wrap: break-word;
    }

    .birth {
      font-size: 11px;
      color: #666;
    }

    .place {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }

    .descendants {
      font-size: 10px;
      color: #666;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 8px;
    }

    /* Bio section */
    .bio-section {
      width: 50%;
      margin: 20px auto;
      background: white;
      border-radius: 12px;
      border: 1px solid #ccc;
      padding: 20px;
      text-align: center;
    }

    .bio-label {
      font-size: 14px;
      font-weight: bold;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
    }

    .bio-content {
      font-size: 14px;
      color: #333;
      line-height: 1.6;
      text-align: left;
      white-space: pre-wrap;
    }

    /* Footer */
    .footer {
      text-align: center;
      font-size: 12px;
      color: #999;
      margin-top: 40px;
      padding: 20px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-state .icon {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .empty-state h2 {
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #666;
      margin-bottom: 20px;
    }

    .btn {
      background: #007AFF;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 16px;
      cursor: pointer;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    /* FAB */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 28px;
      background: #007AFF;
      color: white;
      border: none;
      font-size: 32px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
    }

    .fab:hover {
      background: #0056b3;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h2 {
      font-size: 18px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Form */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .radio-group {
      display: flex;
      gap: 20px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-weight: normal;
    }

    .radio-label input[type="radio"] {
      width: auto;
      cursor: pointer;
    }

    /* Person list modal */
    .person-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .person-list-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .person-list-item:hover {
      background: #f5f5f5;
    }

    .person-list-item .avatar {
      width: 40px;
      height: 40px;
      font-size: 14px;
      margin-right: 12px;
      margin-bottom: 0;
    }

    .person-list-item .info {
      flex: 1;
    }

    .person-list-item .info .name {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .person-list-item .info .year {
      font-size: 12px;
      color: #666;
    }

    .person-list-item .counts {
      font-size: 11px;
      color: #999;
    }

    /* Context menu */
    .context-menu {
      display: none;
      position: fixed;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      min-width: 180px;
      z-index: 2000;
    }

    .context-menu.active {
      display: block;
    }

    .context-menu-item {
      padding: 12px 16px;
      cursor: pointer;
      font-size: 14px;
    }

    .context-menu-item:hover {
      background: #f5f5f5;
    }

    .context-menu-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .context-menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .context-menu-item.danger {
      color: #dc3545;
    }

    /* Photo preview */
    .photo-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px auto;
      overflow: hidden;
    }

    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-preview .placeholder {
      color: #999;
      font-size: 12px;
    }

    /* Hidden file input */
    .hidden {
      display: none;
    }

    /* Static view (CSS-only navigation for no-JS environments) */
    #staticView {
      padding: 20px;
    }
    .person-view { display: none; text-align: center; }
    .person-view:target { display: block; }
    .person-view:target ~ .default-view { display: none; }
    .default-view { display: block; }
    #staticView a { text-decoration: none; color: inherit; }

    /* Avatar images */
  </style>
</head>
<body>
  <div id="staticView"></div>
  <!-- end-static-view -->


  <div class="header">
    <h1 id="headerTitle">Offline Family Tree</h1>
    <button class="header-btn" onclick="openPersonList()" id="listBtn" style="display:none;">List</button>
    <button class="header-btn" onclick="openHtmlFile()">Open</button>
    <button class="header-btn" onclick="exportFullTreeHtml()" id="exportBtn" style="display:none;">Export HTML</button>
    <button class="header-btn" onclick="clearTreeData()" id="clearBtn" style="display:none; color: #dc3545;">Clear</button>
  </div>

  <!-- Main content -->
  <div class="main-content" id="mainContent">
    <!-- Will be populated dynamically -->
  </div>

  <!-- FAB -->
  <button class="fab" onclick="openPersonForm()" id="fabBtn" style="display:none;">+</button>

  <!-- Hidden file input -->
  <input type="file" id="fileInput" class="hidden" accept=".html,.htm" onchange="handleFileSelect(event)">

  <!-- Embedded data (populated when exported) -->
  <script id="embeddedData" type="application/json">null</script>

  <!-- Person Form Modal -->
  <div class="modal-overlay" id="personFormModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="formTitle">Add Person</h2>
        <button class="modal-close" onclick="closePersonForm()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="personId">

        <div class="form-row">
          <div class="form-group">
            <label>Given Name *</label>
            <input type="text" id="givenName" required>
          </div>
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" id="lastName" required>
          </div>
        </div>

        <div class="form-group">
          <label>Gender</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="gender" value="male"> Male
            </label>
            <label class="radio-label">
              <input type="radio" name="gender" value="female"> Female
            </label>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Birth Year</label>
            <input type="number" id="birthYear" min="1800" max="2100">
          </div>
          <div class="form-group">
            <label>Birth Month</label>
            <select id="birthMonth">
              <option value="">Select...</option>
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
          <div class="form-group">
            <label>Birth Day</label>
            <input type="number" id="birthDay" min="1" max="31">
          </div>
        </div>

        <div class="form-group">
          <label>Birth Place</label>
          <input type="text" id="birthPlace">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Father</label>
            <select id="fatherId">
              <option value="">None</option>
            </select>
          </div>
          <div class="form-group">
            <label>Mother</label>
            <select id="motherId">
              <option value="">None</option>
            </select>
          </div>
          <div class="form-group">
            <label>Spouse</label>
            <select id="spouseId">
              <option value="">None</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Photo</label>
          <div class="photo-preview" id="photoPreview">
            <span class="placeholder">No photo</span>
          </div>
          <input type="file" id="photoInput" accept="image/*" onchange="handlePhotoSelect(event)">
        </div>

        <div class="form-group">
          <label>Biography</label>
          <textarea id="bio" placeholder="Enter biography..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePersonForm()">Cancel</button>
        <button class="btn" onclick="savePerson()">Save</button>
      </div>
    </div>
  </div>

  <!-- Person List Modal -->
  <div class="modal-overlay" id="personListModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Select Person</h2>
        <button class="modal-close" onclick="closePersonList()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="person-list" id="personList">
          <!-- Populated dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="editPerson()">Edit</div>
    <div class="context-menu-item" onclick="exportPersonHtml()">Export HTML</div>
    <div class="context-menu-item danger" onclick="deletePerson()">Delete</div>
  </div>

  <script>
    // ============================================
    // DATA STORAGE
    // ============================================
    let persons = [];
    let nextId = 1;
    let focusedPersonId = null;
    let lastModified = null;
    let contextMenuPersonId = null;
    let currentPhotoBase64 = null;

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function getFullName(person) {
      return `${person.givenName} ${person.lastName}`.trim();
    }

    function getInitials(person) {
      const gi = person.givenName ? person.givenName[0].toUpperCase() : '';
      const li = person.lastName ? person.lastName[0].toUpperCase() : '';
      return gi + li;
    }

    function getAvatarClass(gender) {
      if (gender === 'male') return 'male';
      if (gender === 'female') return 'female';
      return 'other';
    }

    function formatBirthDate(person) {
      const months = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
      const parts = [];
      if (person.birthMonth) parts.push(months[person.birthMonth - 1]);
      if (person.birthDay) {
        if (parts.length > 0) parts[0] += ' ' + person.birthDay;
        else parts.push(person.birthDay);
      }
      if (person.birthYear) parts.push(person.birthYear);
      if (parts.length > 1 && person.birthYear) {
        return parts.slice(0, -1).join(' ') + ', ' + parts[parts.length - 1];
      }
      return parts.join(' ');
    }

    function getPersonById(id) {
      return persons.find(p => p.id === id);
    }

    function getChildren(personId) {
      return persons.filter(p => p.fatherId === personId || p.motherId === personId);
    }

    function getSiblings(personId) {
      const person = getPersonById(personId);
      if (!person) return [];
      return persons.filter(p => {
        if (p.id === personId) return false;
        if (person.fatherId && p.fatherId === person.fatherId) return true;
        if (person.motherId && p.motherId === person.motherId) return true;
        return false;
      });
    }

    function getSpouses(personId) {
      const children = getChildren(personId);
      const spouseIds = new Set();
      // Add co-parents (people who share children with this person)
      children.forEach(child => {
        if (child.fatherId && child.fatherId !== personId) spouseIds.add(child.fatherId);
        if (child.motherId && child.motherId !== personId) spouseIds.add(child.motherId);
      });
      // Check explicit spouseId (only if no children, since co-parents already shown)
      if (children.length === 0) {
        const person = getPersonById(personId);
        if (person && person.spouseId) {
          spouseIds.add(person.spouseId);
        }
      }
      // Always check if any childless person has this person as their spouse (bidirectional)
      persons.forEach(p => {
        if (p.spouseId === personId && getChildren(p.id).length === 0) {
          spouseIds.add(p.id);
        }
      });
      return Array.from(spouseIds).map(id => getPersonById(id)).filter(p => p);
    }

    function getDescendants(personId, visited = new Set()) {
      if (visited.has(personId)) return [];
      visited.add(personId);
      const children = getChildren(personId);
      let descendants = [...children];
      children.forEach(child => {
        descendants = descendants.concat(getDescendants(child.id, visited));
      });
      return descendants;
    }

    function getDescendantCount(personId) {
      return getDescendants(personId).length;
    }

    function getParentCount(person) {
      let count = 0;
      if (person.fatherId) count++;
      if (person.motherId) count++;
      return count;
    }

    // ============================================
    // RENDERING
    // ============================================
    function render() {
      const mainContent = document.getElementById('mainContent');
      const fabBtn = document.getElementById('fabBtn');
      const listBtn = document.getElementById('listBtn');
      const exportBtn = document.getElementById('exportBtn');
      const headerTitle = document.getElementById('headerTitle');

      // Update header title with member count
      if (persons.length > 0) {
        headerTitle.textContent = `Offline Family Tree (${persons.length} members)`;
      } else {
        headerTitle.textContent = 'Offline Family Tree';
      }

      if (persons.length === 0) {
        mainContent.innerHTML = `
          <div class="empty-state">
            <div class="icon">&#128106;</div>
            <h2>No Family Members Yet</h2>
            <p>Start building your family tree by adding the first person, or open an existing HTML export.</p>
            <button class="btn" onclick="openPersonForm()">Add First Person</button>
            <button class="btn btn-secondary" style="margin-left: 10px;" onclick="openHtmlFile()">Open HTML File</button>
            <p style="margin-top: 20px; font-size: 12px; color: #999;">Your data is saved in your browser. You can Export HTML to share it (and reimport it later).</p>
          </div>
        `;
        fabBtn.style.display = 'none';
        listBtn.style.display = 'none';
        exportBtn.style.display = 'none';
        document.getElementById('clearBtn').style.display = 'none';
        return;
      }

      fabBtn.style.display = 'block';
      listBtn.style.display = 'block';
      exportBtn.style.display = 'block';
      document.getElementById('clearBtn').style.display = 'block';

      if (!focusedPersonId) {
        focusedPersonId = persons[0].id;
      }

      const person = getPersonById(focusedPersonId);
      if (!person) {
        focusedPersonId = persons[0].id;
        render();
        return;
      }

      const father = person.fatherId ? getPersonById(person.fatherId) : null;
      const mother = person.motherId ? getPersonById(person.motherId) : null;
      const siblings = getSiblings(person.id);
      const spouses = getSpouses(person.id);
      const children = getChildren(person.id);

      let html = '';

      // Person title
      html += `<div class="person-title">${escapeHtml(getFullName(person))}</div>`;

      // Parents row
      if (father || mother) {
        html += '<div class="row-label">Parents</div>';
        html += '<div class="row">';
        if (father) html += renderCard(father, false);
        if (mother) html += renderCard(mother, false);
        html += '</div>';
      }

      // Siblings and spouses row
      html += '<div class="row-label">Siblings and Spouses</div>';
      html += '<div class="row">';
      siblings.forEach(s => { html += renderCard(s, false); });
      html += renderCard(person, true);
      spouses.forEach(s => { html += renderCard(s, false); });
      html += '</div>';

      // Children row
      if (children.length > 0) {
        html += '<div class="row-label">Children</div>';
        html += '<div class="row">';
        children.forEach(c => { html += renderCard(c, false); });
        html += '</div>';
      }

      // Bio section
      html += `
        <div class="bio-section">
          <div class="bio-label">BIO</div>
          <div class="bio-content">${escapeHtml(person.bio || 'No biography available.')}</div>
        </div>
      `;

      // Footer
      html += `<div class="footer">${lastModified ? `Updated on ${lastModified} with ` : 'Created with '}<a href="https://github.com/juliancoccia/familytree" target="_blank">Julian's Family Tree App</a></div>`;

      mainContent.innerHTML = html;
    }

    function renderCard(person, isFocused) {
      const descCount = getDescendantCount(person.id);
      const avatarClass = getAvatarClass(person.gender);
      const birthDate = formatBirthDate(person);

      let avatarContent = '';
      if (person.picture) {
        avatarContent = `<img src="${person.picture}" alt="">`;
      } else {
        avatarContent = getInitials(person);
      }

      return `
        <div class="card ${isFocused ? 'focused' : ''}"
             onclick="focusOnPerson(${person.id})"
             oncontextmenu="showContextMenu(event, ${person.id})">
          <div class="avatar ${avatarClass}">${avatarContent}</div>
          <div class="name">${escapeHtml(getFullName(person))}</div>
          ${birthDate ? `<div class="birth">${escapeHtml(birthDate)}</div>` : ''}
          ${person.birthPlace ? `<div class="place">${escapeHtml(person.birthPlace)}</div>` : ''}
          ${descCount > 0 ? `<div class="descendants">${descCount} descendants</div>` : ''}
        </div>
      `;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
    }

    function formatDateTime() {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return `${year}/${month}/${day} ${hours}:${minutes}`;
    }

    // ============================================
    // PERSON MANAGEMENT
    // ============================================
    function focusOnPerson(id) {
      focusedPersonId = id;
      render();
      autoSave();
    }

    function getGenderRadio() {
      const selected = document.querySelector('input[name="gender"]:checked');
      return selected ? selected.value : null;
    }

    function setGenderRadio(gender) {
      const radios = document.querySelectorAll('input[name="gender"]');
      radios.forEach(radio => {
        radio.checked = (radio.value === gender);
      });
    }

    function clearGenderRadio() {
      const radios = document.querySelectorAll('input[name="gender"]');
      radios.forEach(radio => {
        radio.checked = false;
      });
    }

    function openPersonForm(editId = null) {
      const modal = document.getElementById('personFormModal');
      const title = document.getElementById('formTitle');

      // Populate parent dropdowns
      populateParentDropdowns(editId);

      if (editId) {
        const person = getPersonById(editId);
        if (!person) return;

        title.textContent = 'Edit Person';
        document.getElementById('personId').value = person.id;
        document.getElementById('givenName').value = person.givenName || '';
        document.getElementById('lastName').value = person.lastName || '';
        setGenderRadio(person.gender);
        document.getElementById('birthYear').value = person.birthYear || '';
        document.getElementById('birthMonth').value = person.birthMonth || '';
        document.getElementById('birthDay').value = person.birthDay || '';
        document.getElementById('birthPlace').value = person.birthPlace || '';
        document.getElementById('fatherId').value = person.fatherId || '';
        document.getElementById('motherId').value = person.motherId || '';
        document.getElementById('spouseId').value = person.spouseId || '';
        document.getElementById('bio').value = person.bio || '';
        currentPhotoBase64 = person.picture || null;

        updatePhotoPreview();
      } else {
        title.textContent = 'Add Person';
        document.getElementById('personId').value = '';
        document.getElementById('givenName').value = '';
        document.getElementById('lastName').value = '';
        clearGenderRadio();
        document.getElementById('birthYear').value = '';
        document.getElementById('birthMonth').value = '';
        document.getElementById('birthDay').value = '';
        document.getElementById('birthPlace').value = '';
        document.getElementById('fatherId').value = '';
        document.getElementById('motherId').value = '';
        document.getElementById('spouseId').value = '';
        document.getElementById('bio').value = '';
        currentPhotoBase64 = null;

        updatePhotoPreview();
      }

      modal.classList.add('active');
    }

    function closePersonForm() {
      document.getElementById('personFormModal').classList.remove('active');
      document.getElementById('photoInput').value = '';
      currentPhotoBase64 = null;
    }

    function populateParentDropdowns(excludeId = null) {
      const fatherSelect = document.getElementById('fatherId');
      const motherSelect = document.getElementById('motherId');
      const spouseSelect = document.getElementById('spouseId');

      const males = persons.filter(p => p.gender === 'male' && p.id !== excludeId)
                          .sort((a, b) => getFullName(a).localeCompare(getFullName(b)));
      const females = persons.filter(p => p.gender === 'female' && p.id !== excludeId)
                            .sort((a, b) => getFullName(a).localeCompare(getFullName(b)));
      const others = persons.filter(p => p.gender !== 'male' && p.gender !== 'female' && p.id !== excludeId)
                           .sort((a, b) => getFullName(a).localeCompare(getFullName(b)));
      const allPersons = persons.filter(p => p.id !== excludeId)
                                .sort((a, b) => getFullName(a).localeCompare(getFullName(b)));

      fatherSelect.innerHTML = '<option value="">None</option>';
      males.concat(others).forEach(p => {
        fatherSelect.innerHTML += `<option value="${p.id}">${escapeHtml(getFullName(p))}</option>`;
      });

      motherSelect.innerHTML = '<option value="">None</option>';
      females.concat(others).forEach(p => {
        motherSelect.innerHTML += `<option value="${p.id}">${escapeHtml(getFullName(p))}</option>`;
      });

      spouseSelect.innerHTML = '<option value="">None</option>';
      allPersons.forEach(p => {
        spouseSelect.innerHTML += `<option value="${p.id}">${escapeHtml(getFullName(p))}</option>`;
      });
    }

    function handlePhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        currentPhotoBase64 = e.target.result;
        updatePhotoPreview();
      };
      reader.readAsDataURL(file);
    }

    function updatePhotoPreview() {
      const preview = document.getElementById('photoPreview');
      if (currentPhotoBase64) {
        preview.innerHTML = `<img src="${currentPhotoBase64}" alt="Photo">`;
      } else {
        preview.innerHTML = '<span class="placeholder">No photo</span>';
      }
    }

    function savePerson() {
      const givenName = document.getElementById('givenName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();

      if (!givenName || !lastName) {
        alert('Given name and last name are required.');
        return;
      }

      const personIdStr = document.getElementById('personId').value;
      const isEdit = personIdStr !== '';

      const personData = {
        givenName: givenName,
        lastName: lastName,
        gender: getGenderRadio(),
        birthYear: document.getElementById('birthYear').value ? parseInt(document.getElementById('birthYear').value) : null,
        birthMonth: document.getElementById('birthMonth').value ? parseInt(document.getElementById('birthMonth').value) : null,
        birthDay: document.getElementById('birthDay').value ? parseInt(document.getElementById('birthDay').value) : null,
        birthPlace: document.getElementById('birthPlace').value.trim() || null,
        fatherId: document.getElementById('fatherId').value ? parseInt(document.getElementById('fatherId').value) : null,
        motherId: document.getElementById('motherId').value ? parseInt(document.getElementById('motherId').value) : null,
        spouseId: document.getElementById('spouseId').value ? parseInt(document.getElementById('spouseId').value) : null,
        bio: document.getElementById('bio').value.trim() || null,
        picture: currentPhotoBase64
      };

      if (isEdit) {
        const id = parseInt(personIdStr);
        const index = persons.findIndex(p => p.id === id);
        if (index !== -1) {
          persons[index] = { ...persons[index], ...personData };
        }
      } else {
        personData.id = nextId++;
        persons.push(personData);
        focusedPersonId = personData.id;
      }

      lastModified = formatDateTime();
      closePersonForm();
      render();
      autoSave();
    }

    function editPerson() {
      closeContextMenu();
      if (contextMenuPersonId) {
        openPersonForm(contextMenuPersonId);
      }
    }

    function deletePerson() {
      closeContextMenu();
      if (!contextMenuPersonId) return;

      const person = getPersonById(contextMenuPersonId);
      if (!person) return;

      if (!confirm(`Are you sure you want to delete ${getFullName(person)}?`)) return;

      // Remove person
      persons = persons.filter(p => p.id !== contextMenuPersonId);

      // Clear parent references
      persons.forEach(p => {
        if (p.fatherId === contextMenuPersonId) p.fatherId = null;
        if (p.motherId === contextMenuPersonId) p.motherId = null;
        if (p.spouseId === contextMenuPersonId) p.spouseId = null;
      });

      if (focusedPersonId === contextMenuPersonId) {
        focusedPersonId = persons.length > 0 ? persons[0].id : null;
      }

      lastModified = formatDateTime();
      render();
      autoSave();
    }

    // ============================================
    // CONTEXT MENU
    // ============================================
    function showContextMenu(event, personId) {
      event.preventDefault();
      event.stopPropagation();
      contextMenuPersonId = personId;

      const menu = document.getElementById('contextMenu');
      menu.style.left = event.pageX + 'px';
      menu.style.top = event.pageY + 'px';
      menu.classList.add('active');
    }

    function closeContextMenu() {
      document.getElementById('contextMenu').classList.remove('active');
    }

    document.addEventListener('click', closeContextMenu);

    // ============================================
    // PERSON LIST
    // ============================================
    function openPersonList() {
      const listEl = document.getElementById('personList');
      const sorted = [...persons].sort((a, b) => getFullName(a).localeCompare(getFullName(b)));

      listEl.innerHTML = sorted.map(p => {
        const avatarClass = getAvatarClass(p.gender);
        const avatarContent = p.picture ? `<img src="${p.picture}" alt="">` : getInitials(p);
        const descCount = getDescendantCount(p.id);
        const parentCount = getParentCount(p);

        return `
          <div class="person-list-item" onclick="selectPersonFromList(${p.id})">
            <div class="avatar ${avatarClass}">${avatarContent}</div>
            <div class="info">
              <div class="name">${escapeHtml(getFullName(p))}</div>
              ${p.birthYear ? `<div class="year">${p.birthYear}</div>` : ''}
            </div>
            <div class="counts">${[parentCount > 0 ? `${parentCount} parents` : '', descCount > 0 ? `${descCount} descendants` : ''].filter(x => x).join(', ') || ''}</div>
          </div>
        `;
      }).join('');

      document.getElementById('personListModal').classList.add('active');
    }

    function closePersonList() {
      document.getElementById('personListModal').classList.remove('active');
    }

    function selectPersonFromList(id) {
      closePersonList();
      focusOnPerson(id);
    }

    // ============================================
    // FILE OPERATIONS
    // ============================================
    function openHtmlFile() {
      if (persons.length > 0) {
        const confirmed = confirm(
          `Warning: Opening another HTML file will erase your current ${persons.length} member${persons.length === 1 ? '' : 's'}.\n\nAre you sure you want to continue?`
        );
        if (!confirmed) return;
      }
      document.getElementById('fileInput').click();
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        parseHtmlAndLoad(e.target.result);
      };
      reader.readAsText(file);

      // Reset file input
      event.target.value = '';
    }

    function parseHtmlAndLoad(htmlContent) {
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');

        const embeddedDataEl = doc.getElementById('embeddedData');
        if (!embeddedDataEl) {
          alert('Invalid file: no embedded data found.');
          return;
        }

        const embeddedData = JSON.parse(embeddedDataEl.textContent);
        if (!embeddedData || !embeddedData.persons || embeddedData.persons.length === 0) {
          alert('Invalid file: no family data found.');
          return;
        }

        persons = embeddedData.persons;
        nextId = embeddedData.nextId || (Math.max(...persons.map(p => p.id), 0) + 1);
        focusedPersonId = embeddedData.focusedPersonId || persons[0].id;
        lastModified = embeddedData.lastModified || null;
        render();
        autoSave();
        alert(`Loaded ${persons.length} family members.`);
      } catch (error) {
        console.error('Error parsing HTML:', error);
        alert('Error parsing HTML file. Make sure it\'s a valid Family Tree export.');
      }
    }

    // ============================================
    // HTML EXPORT
    // ============================================
    function exportFullTreeHtml() {
      if (persons.length === 0) return;
      const html = generateExportHtml(persons, focusedPersonId);
      downloadHtml(html, `FamilyTree${formatDateTimeForFilename()}.html`);
    }

    function exportPersonHtml() {
      closeContextMenu();
      if (!contextMenuPersonId) return;

      const person = getPersonById(contextMenuPersonId);
      if (!person) return;

      // Get person and all descendants
      const descendants = getDescendants(contextMenuPersonId);
      const descendantIds = new Set(descendants.map(d => d.id));
      descendantIds.add(contextMenuPersonId);

      // Also include spouses of all these people
      const allIds = new Set(descendantIds);
      descendantIds.forEach(id => {
        getSpouses(id).forEach(s => allIds.add(s.id));
      });

      // Add parents of the root person
      if (person.fatherId) allIds.add(person.fatherId);
      if (person.motherId) allIds.add(person.motherId);
      if (person.spouseId) allIds.add(person.spouseId);

      const personsToExport = persons.filter(p => allIds.has(p.id));
      const html = generateExportHtml(personsToExport, contextMenuPersonId);
      const safeName = getFullName(person).replace(/[^a-zA-Z0-9]/g, '_');
      downloadHtml(html, `FamilyTree${safeName}${formatDateTimeForFilename()}.html`);
    }

    function generateExportHtml(personsData, rootId) {
      const rootPerson = personsData.find(p => p.id === rootId);
      const rootName = rootPerson ? getFullName(rootPerson) : 'Family Tree';
      const dateTimeStr = formatDateTime();

      // Generate CSS for avatar images (each image defined only once)
      let avatarCss = '';
      personsData.forEach(p => {
        if (p.picture) {
          avatarCss += `
    .avatar-${p.id}{background-image:url("${p.picture}");background-size:cover;background-position:center;}`;
        }
      });

      // Generate static views for no-JS fallback
      let staticViewsHtml = '';
      personsData.forEach(p => {
        staticViewsHtml += `<div class="person-view" id="p${p.id}">`;
        staticViewsHtml += renderPersonViewHtml(p.id, personsData);
        staticViewsHtml += '</div>';
      });
      staticViewsHtml += `<div class="person-view default-view" id="default">` +
        renderPersonViewHtml(rootId, personsData) +
        '</div>';
      staticViewsHtml += `<div class="footer">Updated on ${dateTimeStr} with <a href="https://github.com/juliancoccia/familytree" target="_blank">Julian's Family Tree App</a></div>`;

      // Embedded data for JS mode
      const embeddedData = JSON.stringify({
        persons: personsData,
        nextId: Math.max(...personsData.map(p => p.id), 0) + 1,
        focusedPersonId: rootId,
        lastModified: dateTimeStr
      });

      // Get the full app HTML from current document
      // We'll construct it manually to ensure clean export
      return generateFullAppHtml(rootName, personsData.length, avatarCss, staticViewsHtml, embeddedData);
    }

    function generateFullAppHtml(rootName, memberCount, avatarCss, staticViewsHtml, embeddedData) {
      return `<!--
SPDX-License-Identifier: LicenseRef-ELI-1.0
Copyright (C) 2026 Julian Coccia. Released under the Elicitor's Code License 1.0 found in the LICENSE file.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Tree - ${escapeHtml(rootName)}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: #f8f8f8;
      padding: 12px 16px;
      display: none;
      align-items: center;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 20px;
      flex: 1;
    }

    .header-btn {
      background: none;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      border-radius: 4px;
    }

    .header-btn:hover {
      background: #e0e0e0;
    }

    /* Main content */
    .main-content {
      display: none;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Static view (shown when JS disabled) */
    #staticView {
      padding: 20px;
    }

    /* Person views for static mode */
    .person-view { display: none; text-align: center; }
    .person-view:target { display: block; }
    .person-view:target ~ .default-view { display: none; }
    .default-view { display: block; }
    #staticView a { text-decoration: none; color: inherit; }

    /* Person title */
    .person-title {
      font-size: 28px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    /* Row labels */
    .row-label {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin: 10px 0 5px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Card rows */
    .row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin: 0 -8px 15px -8px;
    }

    /* Person card */
    .card {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 140px;
      min-height: 180px;
      background: white;
      border-radius: 12px;
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
      margin: 8px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .card.focused {
      border: 3px solid #FF9800;
      background: #FFF3E0;
    }

    /* Avatar */
    .avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }

    .avatar.male { background-color: #64B5F6; }
    .avatar.female { background-color: #F48FB1; }
    .avatar.other { background-color: #90A4AE; }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .name {
      font-size: 13px;
      font-weight: bold;
      margin-bottom: 4px;
      word-wrap: break-word;
    }

    .birth {
      font-size: 11px;
      color: #666;
    }

    .place {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }

    .descendants {
      font-size: 10px;
      color: #666;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 8px;
    }

    /* Bio section */
    .bio-section {
      width: 50%;
      margin: 20px auto;
      background: white;
      border-radius: 12px;
      border: 1px solid #ccc;
      padding: 20px;
      text-align: center;
    }

    .bio-label {
      font-size: 14px;
      font-weight: bold;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
    }

    .bio-content {
      font-size: 14px;
      color: #333;
      line-height: 1.6;
      text-align: left;
      white-space: pre-wrap;
    }

    /* Footer */
    .footer {
      text-align: center;
      font-size: 12px;
      color: #999;
      margin-top: 40px;
      padding: 20px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-state .icon {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .empty-state h2 {
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #666;
      margin-bottom: 20px;
    }

    .btn {
      background: #007AFF;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 16px;
      cursor: pointer;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    /* FAB */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 28px;
      background: #007AFF;
      color: white;
      border: none;
      font-size: 32px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
    }

    .fab:hover {
      background: #0056b3;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h2 {
      font-size: 18px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Form */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .radio-group {
      display: flex;
      gap: 20px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-weight: normal;
    }

    .radio-label input[type="radio"] {
      width: auto;
      cursor: pointer;
    }

    /* Person list modal */
    .person-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .person-list-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .person-list-item:hover {
      background: #f5f5f5;
    }

    .person-list-item .avatar {
      width: 40px;
      height: 40px;
      font-size: 14px;
      margin-right: 12px;
      margin-bottom: 0;
    }

    .person-list-item .info {
      flex: 1;
    }

    .person-list-item .info .name {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .person-list-item .info .year {
      font-size: 12px;
      color: #666;
    }

    .person-list-item .counts {
      font-size: 11px;
      color: #999;
    }

    /* Context menu */
    .context-menu {
      display: none;
      position: fixed;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      min-width: 180px;
      z-index: 2000;
    }

    .context-menu.active {
      display: block;
    }

    .context-menu-item {
      padding: 12px 16px;
      cursor: pointer;
      font-size: 14px;
    }

    .context-menu-item:hover {
      background: #f5f5f5;
    }

    .context-menu-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .context-menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .context-menu-item.danger {
      color: #dc3545;
    }

    /* Photo preview */
    .photo-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px auto;
      overflow: hidden;
    }

    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-preview .placeholder {
      color: #999;
      font-size: 12px;
    }

    /* Hidden file input */
    .hidden {
      display: none;
    }

    /* Avatar images - each defined once */${avatarCss}
  </style>
</head>
<body>
  <!-- Static view (shown when JS is disabled) -->
  <div id="staticView">
    ${staticViewsHtml}
  </div>
  <!-- end-static-view -->


  <div class="header">
    <h1 id="headerTitle">Family Tree - ${escapeHtml(rootName)} (${memberCount} members)</h1>
    <button class="header-btn" onclick="openPersonList()" id="listBtn">List</button>
    <button class="header-btn" onclick="openHtmlFile()">Open</button>
    <button class="header-btn" onclick="exportFullTreeHtml()" id="exportBtn">Export HTML</button>
    <button class="header-btn" onclick="clearTreeData()" id="clearBtn" style="color: #dc3545;">Clear</button>
  </div>

  <!-- Main content (shown when JS is enabled) -->
  <div class="main-content" id="mainContent">
  </div>

  <!-- FAB -->
  <button class="fab" onclick="openPersonForm()" id="fabBtn" style="display:none;">+</button>

  <!-- Hidden file input -->
  <input type="file" id="fileInput" class="hidden" accept=".html,.htm" onchange="handleFileSelect(event)">

  <!-- Embedded data -->
  <script id="embeddedData" type="application/json">${embeddedData}<\/script>

  <!-- Person Form Modal -->
  <div class="modal-overlay" id="personFormModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="formTitle">Add Person</h2>
        <button class="modal-close" onclick="closePersonForm()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="personId">

        <div class="form-row">
          <div class="form-group">
            <label>Given Name *</label>
            <input type="text" id="givenName" required>
          </div>
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" id="lastName" required>
          </div>
        </div>

        <div class="form-group">
          <label>Gender</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="gender" value="male"> Male
            </label>
            <label class="radio-label">
              <input type="radio" name="gender" value="female"> Female
            </label>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Birth Year</label>
            <input type="number" id="birthYear" min="1800" max="2100">
          </div>
          <div class="form-group">
            <label>Birth Month</label>
            <select id="birthMonth">
              <option value="">Select...</option>
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
          <div class="form-group">
            <label>Birth Day</label>
            <input type="number" id="birthDay" min="1" max="31">
          </div>
        </div>

        <div class="form-group">
          <label>Birth Place</label>
          <input type="text" id="birthPlace">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Father</label>
            <select id="fatherId">
              <option value="">None</option>
            </select>
          </div>
          <div class="form-group">
            <label>Mother</label>
            <select id="motherId">
              <option value="">None</option>
            </select>
          </div>
          <div class="form-group">
            <label>Spouse</label>
            <select id="spouseId">
              <option value="">None</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Photo</label>
          <div class="photo-preview" id="photoPreview">
            <span class="placeholder">No photo</span>
          </div>
          <input type="file" id="photoInput" accept="image/*" onchange="handlePhotoSelect(event)">
        </div>

        <div class="form-group">
          <label>Biography</label>
          <textarea id="bio" placeholder="Enter biography..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePersonForm()">Cancel</button>
        <button class="btn" onclick="savePerson()">Save</button>
      </div>
    </div>
  </div>

  <!-- Person List Modal -->
  <div class="modal-overlay" id="personListModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Select Person</h2>
        <button class="modal-close" onclick="closePersonList()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="person-list" id="personList">
        </div>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="editPerson()">Edit</div>
    <div class="context-menu-item" onclick="exportPersonHtml()">Export HTML</div>
    <div class="context-menu-item danger" onclick="deletePerson()">Delete</div>
  </div>

  <script>
    // ============================================
    // DATA STORAGE
    // ============================================
    let persons = [];
    let nextId = 1;
    let focusedPersonId = null;
    let lastModified = null;
    let contextMenuPersonId = null;
    let currentPhotoBase64 = null;

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function getFullName(person) {
      return \`\${person.givenName} \${person.lastName}\`.trim();
    }

    function getInitials(person) {
      const gi = person.givenName ? person.givenName[0].toUpperCase() : '';
      const li = person.lastName ? person.lastName[0].toUpperCase() : '';
      return gi + li;
    }

    function getAvatarClass(gender) {
      if (gender === 'male') return 'male';
      if (gender === 'female') return 'female';
      return 'other';
    }

    function formatBirthDate(person) {
      const months = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
      const parts = [];
      if (person.birthMonth) parts.push(months[person.birthMonth - 1]);
      if (person.birthDay) {
        if (parts.length > 0) parts[0] += ' ' + person.birthDay;
        else parts.push(person.birthDay);
      }
      if (person.birthYear) parts.push(person.birthYear);
      if (parts.length > 1 && person.birthYear) {
        return parts.slice(0, -1).join(' ') + ', ' + parts[parts.length - 1];
      }
      return parts.join(' ');
    }

    function getPersonById(id) {
      return persons.find(p => p.id === id);
    }

    function getChildren(personId) {
      return persons.filter(p => p.fatherId === personId || p.motherId === personId);
    }

    function getSiblings(personId) {
      const person = getPersonById(personId);
      if (!person) return [];
      return persons.filter(p => {
        if (p.id === personId) return false;
        if (person.fatherId && p.fatherId === person.fatherId) return true;
        if (person.motherId && p.motherId === person.motherId) return true;
        return false;
      });
    }

    function getSpouses(personId) {
      const children = getChildren(personId);
      const spouseIds = new Set();
      // Add co-parents (people who share children with this person)
      children.forEach(child => {
        if (child.fatherId && child.fatherId !== personId) spouseIds.add(child.fatherId);
        if (child.motherId && child.motherId !== personId) spouseIds.add(child.motherId);
      });
      // Check explicit spouseId (only if no children, since co-parents already shown)
      if (children.length === 0) {
        const person = getPersonById(personId);
        if (person && person.spouseId) {
          spouseIds.add(person.spouseId);
        }
      }
      // Always check if any childless person has this person as their spouse (bidirectional)
      persons.forEach(p => {
        if (p.spouseId === personId && getChildren(p.id).length === 0) {
          spouseIds.add(p.id);
        }
      });
      return Array.from(spouseIds).map(id => getPersonById(id)).filter(p => p);
    }

    function getDescendants(personId, visited = new Set()) {
      if (visited.has(personId)) return [];
      visited.add(personId);
      const children = getChildren(personId);
      let descendants = [...children];
      children.forEach(child => {
        descendants = descendants.concat(getDescendants(child.id, visited));
      });
      return descendants;
    }

    function getDescendantCount(personId) {
      return getDescendants(personId).length;
    }

    function getParentCount(person) {
      let count = 0;
      if (person.fatherId) count++;
      if (person.motherId) count++;
      return count;
    }

    // ============================================
    // RENDERING
    // ============================================
    function render() {
      const mainContent = document.getElementById('mainContent');
      const fabBtn = document.getElementById('fabBtn');
      const listBtn = document.getElementById('listBtn');
      const exportBtn = document.getElementById('exportBtn');
      const headerTitle = document.getElementById('headerTitle');

      // Update header title with member count
      if (persons.length > 0) {
        headerTitle.textContent = \`Offline Family Tree (\${persons.length} members)\`;
      } else {
        headerTitle.textContent = 'Offline Family Tree';
      }

      if (persons.length === 0) {
        mainContent.innerHTML = \`
          <div class="empty-state">
            <div class="icon">&#128106;</div>
            <h2>No Family Members Yet</h2>
            <p>Start building your family tree by adding the first person, or open an existing HTML export.</p>
            <button class="btn" onclick="openPersonForm()">Add First Person</button>
            <button class="btn btn-secondary" style="margin-left: 10px;" onclick="openHtmlFile()">Open HTML File</button>
            <p style="margin-top: 20px; font-size: 12px; color: #999;">Your data is saved in your browser. You can Export HTML to share it (and reimport it later).</p>
          </div>
        \`;
        fabBtn.style.display = 'none';
        listBtn.style.display = 'none';
        exportBtn.style.display = 'none';
        document.getElementById('clearBtn').style.display = 'none';
        return;
      }

      fabBtn.style.display = 'block';
      listBtn.style.display = 'block';
      exportBtn.style.display = 'block';
      document.getElementById('clearBtn').style.display = 'block';

      if (!focusedPersonId) {
        focusedPersonId = persons[0].id;
      }

      const person = getPersonById(focusedPersonId);
      if (!person) {
        focusedPersonId = persons[0].id;
        render();
        return;
      }

      const father = person.fatherId ? getPersonById(person.fatherId) : null;
      const mother = person.motherId ? getPersonById(person.motherId) : null;
      const siblings = getSiblings(person.id);
      const spouses = getSpouses(person.id);
      const children = getChildren(person.id);

      let html = '';

      // Person title
      html += \`<div class="person-title">\${escapeHtml(getFullName(person))}</div>\`;

      // Parents row
      if (father || mother) {
        html += '<div class="row-label">Parents</div>';
        html += '<div class="row">';
        if (father) html += renderCard(father, false);
        if (mother) html += renderCard(mother, false);
        html += '</div>';
      }

      // Siblings and spouses row
      html += '<div class="row-label">Siblings and Spouses</div>';
      html += '<div class="row">';
      siblings.forEach(s => { html += renderCard(s, false); });
      html += renderCard(person, true);
      spouses.forEach(s => { html += renderCard(s, false); });
      html += '</div>';

      // Children row
      if (children.length > 0) {
        html += '<div class="row-label">Children</div>';
        html += '<div class="row">';
        children.forEach(c => { html += renderCard(c, false); });
        html += '</div>';
      }

      // Bio section
      html += \`
        <div class="bio-section">
          <div class="bio-label">BIO</div>
          <div class="bio-content">\${escapeHtml(person.bio || 'No biography available.')}</div>
        </div>
      \`;

      // Footer
      html += \`<div class="footer">\${lastModified ? \`Updated on \${lastModified} with \` : 'Created with '}<a href="https://github.com/juliancoccia/familytree" target="_blank">Julian's Family Tree App</a></div>\`;

      mainContent.innerHTML = html;
    }

    function renderCard(person, isFocused) {
      const descCount = getDescendantCount(person.id);
      const avatarClass = getAvatarClass(person.gender);
      const avatarImageClass = person.picture ? \` avatar-\${person.id}\` : '';
      const avatarContent = person.picture ? '' : getInitials(person);
      const birthDate = formatBirthDate(person);

      return \`
        <div class="card \${isFocused ? 'focused' : ''}"
             onclick="focusOnPerson(\${person.id})"
             oncontextmenu="showContextMenu(event, \${person.id})">
          <div class="avatar \${avatarClass}\${avatarImageClass}">\${avatarContent}</div>
          <div class="name">\${escapeHtml(getFullName(person))}</div>
          \${birthDate ? \`<div class="birth">\${escapeHtml(birthDate)}</div>\` : ''}
          \${person.birthPlace ? \`<div class="place">\${escapeHtml(person.birthPlace)}</div>\` : ''}
          \${descCount > 0 ? \`<div class="descendants">\${descCount} descendants</div>\` : ''}
        </div>
      \`;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
    }

    function formatDateTime() {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return \`\${year}/\${month}/\${day} \${hours}:\${minutes}\`;
    }

    // ============================================
    // PERSON MANAGEMENT
    // ============================================
    function focusOnPerson(id) {
      focusedPersonId = id;
      render();
      autoSave();
    }

    function getGenderRadio() {
      const selected = document.querySelector('input[name="gender"]:checked');
      return selected ? selected.value : null;
    }

    function setGenderRadio(gender) {
      const radios = document.querySelectorAll('input[name="gender"]');
      radios.forEach(radio => {
        radio.checked = (radio.value === gender);
      });
    }

    function clearGenderRadio() {
      const radios = document.querySelectorAll('input[name="gender"]');
      radios.forEach(radio => {
        radio.checked = false;
      });
    }

    function openPersonForm(editId = null) {
      const modal = document.getElementById('personFormModal');
      const title = document.getElementById('formTitle');

      populateParentDropdowns(editId);

      if (editId) {
        const person = getPersonById(editId);
        if (!person) return;

        title.textContent = 'Edit Person';
        document.getElementById('personId').value = person.id;
        document.getElementById('givenName').value = person.givenName || '';
        document.getElementById('lastName').value = person.lastName || '';
        setGenderRadio(person.gender);
        document.getElementById('birthYear').value = person.birthYear || '';
        document.getElementById('birthMonth').value = person.birthMonth || '';
        document.getElementById('birthDay').value = person.birthDay || '';
        document.getElementById('birthPlace').value = person.birthPlace || '';
        document.getElementById('fatherId').value = person.fatherId || '';
        document.getElementById('motherId').value = person.motherId || '';
        document.getElementById('spouseId').value = person.spouseId || '';
        document.getElementById('bio').value = person.bio || '';
        currentPhotoBase64 = person.picture || null;

        updatePhotoPreview();
      } else {
        title.textContent = 'Add Person';
        document.getElementById('personId').value = '';
        document.getElementById('givenName').value = '';
        document.getElementById('lastName').value = '';
        clearGenderRadio();
        document.getElementById('birthYear').value = '';
        document.getElementById('birthMonth').value = '';
        document.getElementById('birthDay').value = '';
        document.getElementById('birthPlace').value = '';
        document.getElementById('fatherId').value = '';
        document.getElementById('motherId').value = '';
        document.getElementById('spouseId').value = '';
        document.getElementById('bio').value = '';
        currentPhotoBase64 = null;

        updatePhotoPreview();
      }

      modal.classList.add('active');
    }

    function closePersonForm() {
      document.getElementById('personFormModal').classList.remove('active');
      document.getElementById('photoInput').value = '';
      currentPhotoBase64 = null;
    }

    function populateParentDropdowns(excludeId = null) {
      const fatherSelect = document.getElementById('fatherId');
      const motherSelect = document.getElementById('motherId');
      const spouseSelect = document.getElementById('spouseId');

      const males = persons.filter(p => p.gender === 'male' && p.id !== excludeId)
                          .sort((a, b) => getFullName(a).localeCompare(getFullName(b)));
      const females = persons.filter(p => p.gender === 'female' && p.id !== excludeId)
                            .sort((a, b) => getFullName(a).localeCompare(getFullName(b)));
      const others = persons.filter(p => p.gender !== 'male' && p.gender !== 'female' && p.id !== excludeId)
                           .sort((a, b) => getFullName(a).localeCompare(getFullName(b)));
      const allPersons = persons.filter(p => p.id !== excludeId)
                                .sort((a, b) => getFullName(a).localeCompare(getFullName(b)));

      fatherSelect.innerHTML = '<option value="">None</option>';
      males.concat(others).forEach(p => {
        fatherSelect.innerHTML += \`<option value="\${p.id}">\${escapeHtml(getFullName(p))}</option>\`;
      });

      motherSelect.innerHTML = '<option value="">None</option>';
      females.concat(others).forEach(p => {
        motherSelect.innerHTML += \`<option value="\${p.id}">\${escapeHtml(getFullName(p))}</option>\`;
      });

      spouseSelect.innerHTML = '<option value="">None</option>';
      allPersons.forEach(p => {
        spouseSelect.innerHTML += \`<option value="\${p.id}">\${escapeHtml(getFullName(p))}</option>\`;
      });
    }

    function handlePhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        currentPhotoBase64 = e.target.result;
        updatePhotoPreview();
      };
      reader.readAsDataURL(file);
    }

    function updatePhotoPreview() {
      const preview = document.getElementById('photoPreview');
      if (currentPhotoBase64) {
        preview.innerHTML = \`<img src="\${currentPhotoBase64}" alt="Photo">\`;
      } else {
        preview.innerHTML = '<span class="placeholder">No photo</span>';
      }
    }

    function savePerson() {
      const givenName = document.getElementById('givenName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();

      if (!givenName || !lastName) {
        alert('Given name and last name are required.');
        return;
      }

      const personIdStr = document.getElementById('personId').value;
      const isEdit = personIdStr !== '';

      const personData = {
        givenName: givenName,
        lastName: lastName,
        gender: getGenderRadio(),
        birthYear: document.getElementById('birthYear').value ? parseInt(document.getElementById('birthYear').value) : null,
        birthMonth: document.getElementById('birthMonth').value ? parseInt(document.getElementById('birthMonth').value) : null,
        birthDay: document.getElementById('birthDay').value ? parseInt(document.getElementById('birthDay').value) : null,
        birthPlace: document.getElementById('birthPlace').value.trim() || null,
        fatherId: document.getElementById('fatherId').value ? parseInt(document.getElementById('fatherId').value) : null,
        motherId: document.getElementById('motherId').value ? parseInt(document.getElementById('motherId').value) : null,
        spouseId: document.getElementById('spouseId').value ? parseInt(document.getElementById('spouseId').value) : null,
        bio: document.getElementById('bio').value.trim() || null,
        picture: currentPhotoBase64
      };

      if (isEdit) {
        const id = parseInt(personIdStr);
        const index = persons.findIndex(p => p.id === id);
        if (index !== -1) {
          persons[index] = { ...persons[index], ...personData };
        }
      } else {
        personData.id = nextId++;
        persons.push(personData);
        focusedPersonId = personData.id;
      }

      lastModified = formatDateTime();
      closePersonForm();
      render();
      autoSave();
    }

    function editPerson() {
      closeContextMenu();
      if (contextMenuPersonId) {
        openPersonForm(contextMenuPersonId);
      }
    }

    function deletePerson() {
      closeContextMenu();
      if (!contextMenuPersonId) return;

      const person = getPersonById(contextMenuPersonId);
      if (!person) return;

      if (!confirm(\`Are you sure you want to delete \${getFullName(person)}?\`)) return;

      persons = persons.filter(p => p.id !== contextMenuPersonId);

      persons.forEach(p => {
        if (p.fatherId === contextMenuPersonId) p.fatherId = null;
        if (p.motherId === contextMenuPersonId) p.motherId = null;
        if (p.spouseId === contextMenuPersonId) p.spouseId = null;
      });

      if (focusedPersonId === contextMenuPersonId) {
        focusedPersonId = persons.length > 0 ? persons[0].id : null;
      }

      lastModified = formatDateTime();
      render();
      autoSave();
    }

    // ============================================
    // CONTEXT MENU
    // ============================================
    function showContextMenu(event, personId) {
      event.preventDefault();
      event.stopPropagation();
      contextMenuPersonId = personId;

      const menu = document.getElementById('contextMenu');
      menu.style.left = event.pageX + 'px';
      menu.style.top = event.pageY + 'px';
      menu.classList.add('active');
    }

    function closeContextMenu() {
      document.getElementById('contextMenu').classList.remove('active');
    }

    document.addEventListener('click', closeContextMenu);

    // ============================================
    // PERSON LIST
    // ============================================
    function openPersonList() {
      const listEl = document.getElementById('personList');
      const sorted = [...persons].sort((a, b) => getFullName(a).localeCompare(getFullName(b)));

      listEl.innerHTML = sorted.map(p => {
        const avatarClass = getAvatarClass(p.gender);
        const avatarImageClass = p.picture ? \` avatar-\${p.id}\` : '';
        const avatarContent = p.picture ? '' : getInitials(p);
        const descCount = getDescendantCount(p.id);
        const parentCount = getParentCount(p);

        return \`
          <div class="person-list-item" onclick="selectPersonFromList(\${p.id})">
            <div class="avatar \${avatarClass}\${avatarImageClass}">\${avatarContent}</div>
            <div class="info">
              <div class="name">\${escapeHtml(getFullName(p))}</div>
              \${p.birthYear ? \`<div class="year">\${p.birthYear}</div>\` : ''}
            </div>
            <div class="counts">\${[parentCount > 0 ? \`\${parentCount} parents\` : '', descCount > 0 ? \`\${descCount} descendants\` : ''].filter(x => x).join(', ') || ''}</div>
          </div>
        \`;
      }).join('');

      document.getElementById('personListModal').classList.add('active');
    }

    function closePersonList() {
      document.getElementById('personListModal').classList.remove('active');
    }

    function selectPersonFromList(id) {
      closePersonList();
      focusOnPerson(id);
    }

    // ============================================
    // FILE OPERATIONS
    // ============================================
    function openHtmlFile() {
      if (persons.length > 0) {
        const confirmed = confirm(
          \`Warning: Opening another HTML file will erase your current \${persons.length} member\${persons.length === 1 ? '' : 's'}.\\n\\nAre you sure you want to continue?\`
        );
        if (!confirmed) return;
      }
      document.getElementById('fileInput').click();
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        parseHtmlAndLoad(e.target.result);
      };
      reader.readAsText(file);

      event.target.value = '';
    }

    function parseHtmlAndLoad(htmlContent) {
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');

        const embeddedDataEl = doc.getElementById('embeddedData');
        if (!embeddedDataEl) {
          alert('Invalid file: no embedded data found.');
          return;
        }

        const embeddedData = JSON.parse(embeddedDataEl.textContent);
        if (!embeddedData || !embeddedData.persons || embeddedData.persons.length === 0) {
          alert('Invalid file: no family data found.');
          return;
        }

        persons = embeddedData.persons;
        nextId = embeddedData.nextId || (Math.max(...persons.map(p => p.id), 0) + 1);
        focusedPersonId = embeddedData.focusedPersonId || persons[0].id;
        lastModified = embeddedData.lastModified || null;
        render();
        autoSave();
        alert(\`Loaded \${persons.length} family members.\`);
      } catch (error) {
        console.error('Error parsing HTML:', error);
        alert('Error parsing HTML file. Make sure it is a valid Family Tree export.');
      }
    }

    // ============================================
    // HTML EXPORT
    // ============================================
    function exportFullTreeHtml() {
      if (persons.length === 0) return;
      const html = generateExportHtml(persons, focusedPersonId);
      downloadHtml(html, \`FamilyTree\${formatDateTimeForFilename()}.html\`);
    }

    function exportPersonHtml() {
      closeContextMenu();
      if (!contextMenuPersonId) return;

      const person = getPersonById(contextMenuPersonId);
      if (!person) return;

      const descendants = getDescendants(contextMenuPersonId);
      const descendantIds = new Set(descendants.map(d => d.id));
      descendantIds.add(contextMenuPersonId);

      const allIds = new Set(descendantIds);
      descendantIds.forEach(id => {
        getSpouses(id).forEach(s => allIds.add(s.id));
      });

      if (person.fatherId) allIds.add(person.fatherId);
      if (person.motherId) allIds.add(person.motherId);
      if (person.spouseId) allIds.add(person.spouseId);

      const personsToExport = persons.filter(p => allIds.has(p.id));
      const html = generateExportHtml(personsToExport, contextMenuPersonId);
      const safeName = getFullName(person).replace(/[^a-zA-Z0-9]/g, '_');
      downloadHtml(html, \`FamilyTree\${safeName}\${formatDateTimeForFilename()}.html\`);
    }

    function generateExportHtml(personsData, rootId) {
      // Clone current document and update embedded data
      const rootPerson = personsData.find(p => p.id === rootId);
      const rootName = rootPerson ? getFullName(rootPerson) : 'Family Tree';
      const dateTimeStr = formatDateTime();

      // Build new embedded data
      const newEmbeddedData = JSON.stringify({
        persons: personsData,
        nextId: Math.max(...personsData.map(p => p.id), 0) + 1,
        focusedPersonId: rootId,
        lastModified: dateTimeStr
      });

      // Build avatar CSS
      let avatarCss = '';
      personsData.forEach(p => {
        if (p.picture) {
          avatarCss += \`
    .avatar-\${p.id}{background-image:url("\${p.picture}");background-size:cover;background-position:center;}\`;
        }
      });

      // Build static views HTML
      let staticViewsHtml = '';
      personsData.forEach(p => {
        staticViewsHtml += \`<div class="person-view" id="p\${p.id}">\`;
        staticViewsHtml += renderPersonViewHtml(p.id, personsData);
        staticViewsHtml += '</div>';
      });
      staticViewsHtml += \`<div class="person-view default-view" id="default">\` +
        renderPersonViewHtml(rootId, personsData) +
        '</div>';
      staticViewsHtml += \`<div class="footer">Updated on \${dateTimeStr} with <a href="https://github.com/juliancoccia/familytree" target="_blank">Julian's Family Tree App</a></div>\`;

      // Get current document HTML and update it
      let html = document.documentElement.outerHTML;

      // Update the embedded data
      html = html.replace(
        /<script id="embeddedData" type="application\\/json">[\\s\\S]*?<\\/script>/,
        '<script id="embeddedData" type="application/json">' + newEmbeddedData + '<\\/script>'
      );

      // Update the static view (use end marker)
      html = html.replace(
        /<div id="staticView">[\\s\\S]*?<!-- end-static-view -->/,
        '<div id="staticView">' + staticViewsHtml + '</div>\\n  <!-- end-static-view -->'
      );

      // Update avatar CSS (between /* Avatar images */ markers or append to style)
      const avatarCssMarker = /\\/\\* Avatar images \\*\\/[\\s\\S]*?(?=\\/\\*|<\\/style>)/;
      if (avatarCssMarker.test(html)) {
        html = html.replace(avatarCssMarker, '/* Avatar images */' + avatarCss + '\\n    ');
      }

      // Update title
      html = html.replace(/<title>[^<]*<\\/title>/, '<title>Family Tree - ' + escapeHtml(rootName) + '</title>');

      // Update header title
      const memberCount = personsData.length;
      const headerTitle = 'Offline Family Tree' + (memberCount > 0 ? ' (' + memberCount + ' members)' : '');
      html = html.replace(
        /<h1 id="headerTitle">[^<]*<\\/h1>/,
        '<h1 id="headerTitle">' + headerTitle + '</h1>'
      );

      // Fix header CSS: change display: flex to display: none (so it's hidden when JS is disabled)
      html = html.replace(
        /\\.header\\s*\\{([^}]*?)display:\\s*flex/,
        '.header {$1display: none'
      );

      // Fix main-content CSS: ensure it's hidden by default
      html = html.replace(
        /\\.main-content\\s*\\{([^}]*?)display:\\s*block/,
        '.main-content {$1display: none'
      );

      // Add DOCTYPE if missing
      if (!html.startsWith('<!DOCTYPE') && !html.startsWith('<!--')) {
        html = '<!DOCTYPE html>\\n' + html;
      }

      return html;
    }

    function renderPersonViewHtml(personId, personsData) {
      const person = personsData.find(p => p.id === personId);
      if (!person) return '';

      const father = person.fatherId ? personsData.find(p => p.id === person.fatherId) : null;
      const mother = person.motherId ? personsData.find(p => p.id === person.motherId) : null;

      const siblings = personsData.filter(p => {
        if (p.id === personId) return false;
        if (person.fatherId && p.fatherId === person.fatherId) return true;
        if (person.motherId && p.motherId === person.motherId) return true;
        return false;
      });

      const children = personsData.filter(p => p.fatherId === personId || p.motherId === personId);

      const spouseIds = new Set();
      // Add co-parents (people who share children with this person)
      children.forEach(child => {
        if (child.fatherId && child.fatherId !== personId) {
          if (personsData.find(p => p.id === child.fatherId)) spouseIds.add(child.fatherId);
        }
        if (child.motherId && child.motherId !== personId) {
          if (personsData.find(p => p.id === child.motherId)) spouseIds.add(child.motherId);
        }
      });
      // Check explicit spouseId (only if no children, since co-parents already shown)
      if (children.length === 0) {
        if (person.spouseId && personsData.find(p => p.id === person.spouseId)) {
          spouseIds.add(person.spouseId);
        }
      }
      // Always check if any childless person has this person as their spouse (bidirectional)
      personsData.forEach(p => {
        if (p.spouseId === personId) {
          const pChildren = personsData.filter(c => c.fatherId === p.id || c.motherId === p.id);
          if (pChildren.length === 0) spouseIds.add(p.id);
        }
      });
      const spouses = Array.from(spouseIds).map(id => personsData.find(p => p.id === id)).filter(p => p);

      let html = '';
      html += \`<div class="person-title">\${escapeHtml(getFullName(person))}</div>\`;

      if (father || mother) {
        html += '<div class="row-label">Parents</div><div class="row">';
        if (father) html += renderCardHtml(father, false, personsData);
        if (mother) html += renderCardHtml(mother, false, personsData);
        html += '</div>';
      }

      html += '<div class="row-label">Siblings and Spouses</div><div class="row">';
      siblings.forEach(s => { html += renderCardHtml(s, false, personsData); });
      html += renderCardHtml(person, true, personsData);
      spouses.forEach(s => { html += renderCardHtml(s, false, personsData); });
      html += '</div>';

      if (children.length > 0) {
        html += '<div class="row-label">Children</div><div class="row">';
        children.forEach(c => { html += renderCardHtml(c, false, personsData); });
        html += '</div>';
      }

      html += \`<div class="bio-section">
        <div class="bio-label">BIO</div>
        <div class="bio-content">\${escapeHtml(person.bio || 'No biography available.')}</div>
      </div>\`;

      return html;
    }

    function renderCardHtml(person, isFocused, personsData) {
      const descCount = getDescendantCountForExport(person.id, personsData);
      const avatarClass = getAvatarClass(person.gender);
      const avatarImageClass = person.picture ? \` avatar-\${person.id}\` : '';
      const avatarContent = person.picture ? '' : getInitials(person);
      const birthDate = formatBirthDate(person);

      const cardContent = \`
        <div class="avatar \${avatarClass}\${avatarImageClass}">\${avatarContent}</div>
        <div class="name">\${escapeHtml(getFullName(person))}</div>
        \${birthDate ? \`<div class="birth">\${escapeHtml(birthDate)}</div>\` : ''}
        \${person.birthPlace ? \`<div class="place">\${escapeHtml(person.birthPlace)}</div>\` : ''}
        \${descCount > 0 ? \`<div class="descendants">\${descCount} descendants</div>\` : ''}
      \`;

      if (isFocused) {
        return \`<div class="card focused">\${cardContent}</div>\`;
      } else {
        return \`<a href="#p\${person.id}"><div class="card">\${cardContent}</div></a>\`;
      }
    }

    function getDescendantCountForExport(personId, personsData) {
      const visited = new Set();
      const countDescendants = (id) => {
        if (visited.has(id)) return 0;
        visited.add(id);
        const children = personsData.filter(p => p.fatherId === id || p.motherId === id);
        let count = children.length;
        children.forEach(c => { count += countDescendants(c.id); });
        return count;
      };
      return countDescendants(personId);
    }

    function downloadHtml(content, filename) {
      const blob = new Blob([content], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ============================================
    // INDEXEDDB STORAGE
    // ============================================
    const DB_NAME = 'FamilyTreeDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'familyData';
    let db = null;

    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };

        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          if (!database.objectStoreNames.contains(STORE_NAME)) {
            database.createObjectStore(STORE_NAME, { keyPath: 'key' });
          }
        };
      });
    }

    function saveToIndexedDB() {
      if (!db) return;

      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);

      const data = {
        key: 'treeData',
        persons: persons,
        nextId: nextId,
        focusedPersonId: focusedPersonId,
        lastModified: lastModified
      };

      store.put(data);
    }

    function loadFromIndexedDB() {
      return new Promise((resolve, reject) => {
        if (!db) {
          resolve(null);
          return;
        }

        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get('treeData');

        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
      });
    }

    function clearIndexedDB() {
      return new Promise((resolve, reject) => {
        if (!db) {
          resolve();
          return;
        }

        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete('treeData');

        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve();
      });
    }

    function autoSave() {
      saveToIndexedDB();
    }

    // ============================================
    // CLEAR TREE DATA
    // ============================================
    async function clearTreeData() {
      if (persons.length === 0) return;

      const confirmed = confirm(
        'Are you sure you want to clear all family tree data?\\n\\n' +
        'A backup HTML file will be downloaded before clearing.'
      );

      if (!confirmed) return;

      const html = generateExportHtml(persons, focusedPersonId);
      downloadHtml(html, \`FamilyTreeBackup\${formatDateTimeForFilename()}.html\`);

      persons = [];
      nextId = 1;
      focusedPersonId = null;
      lastModified = null;

      await clearIndexedDB();

      render();
    }

    function formatDateTimeForFilename() {
      const now = new Date();
      const yy = String(now.getFullYear()).slice(-2);
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      return \`\${yy}\${month}\${day}\${hours}\${minutes}\${seconds}\`;
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    async function init() {
      const embeddedDataEl = document.getElementById('embeddedData');
      if (embeddedDataEl) {
        try {
          const embeddedData = JSON.parse(embeddedDataEl.textContent);
          if (embeddedData && embeddedData.persons && embeddedData.persons.length > 0) {
            persons = embeddedData.persons;
            nextId = embeddedData.nextId || (Math.max(...persons.map(p => p.id), 0) + 1);
            focusedPersonId = embeddedData.focusedPersonId || persons[0].id;
            lastModified = embeddedData.lastModified || null;

            const staticView = document.getElementById('staticView');
            if (staticView) staticView.style.display = 'none';

            document.querySelector('.header').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'block';

            render();
            return;
          }
        } catch (e) {
          // No valid embedded data
        }
      }

      const staticView = document.getElementById('staticView');
      if (staticView) staticView.style.display = 'none';

      document.querySelector('.header').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'block';

      try {
        await openDatabase();
        const savedData = await loadFromIndexedDB();

        if (savedData && savedData.persons && savedData.persons.length > 0) {
          persons = savedData.persons;
          nextId = savedData.nextId || (Math.max(...persons.map(p => p.id), 0) + 1);
          focusedPersonId = savedData.focusedPersonId || persons[0].id;
          lastModified = savedData.lastModified || null;
        }
      } catch (error) {
        console.error('Error loading from IndexedDB:', error);
      }

      render();
    }

    init();
  <\/script>
</body>
</html>`;
    }

    function renderPersonViewHtml(personId, personsData) {
      const person = personsData.find(p => p.id === personId);
      if (!person) return '';

      const father = person.fatherId ? personsData.find(p => p.id === person.fatherId) : null;
      const mother = person.motherId ? personsData.find(p => p.id === person.motherId) : null;

      // Get siblings (share at least one parent)
      const siblings = personsData.filter(p => {
        if (p.id === personId) return false;
        if (person.fatherId && p.fatherId === person.fatherId) return true;
        if (person.motherId && p.motherId === person.motherId) return true;
        return false;
      });

      // Get children
      const children = personsData.filter(p => p.fatherId === personId || p.motherId === personId);

      // Get spouses (co-parents)
      const spouseIds = new Set();
      // Add co-parents (people who share children with this person)
      children.forEach(child => {
        if (child.fatherId && child.fatherId !== personId) {
          if (personsData.find(p => p.id === child.fatherId)) spouseIds.add(child.fatherId);
        }
        if (child.motherId && child.motherId !== personId) {
          if (personsData.find(p => p.id === child.motherId)) spouseIds.add(child.motherId);
        }
      });
      // Check explicit spouseId (only if no children, since co-parents already shown)
      if (children.length === 0) {
        if (person.spouseId && personsData.find(p => p.id === person.spouseId)) {
          spouseIds.add(person.spouseId);
        }
      }
      // Always check if any childless person has this person as their spouse (bidirectional)
      personsData.forEach(p => {
        if (p.spouseId === personId) {
          const pChildren = personsData.filter(c => c.fatherId === p.id || c.motherId === p.id);
          if (pChildren.length === 0) spouseIds.add(p.id);
        }
      });
      const spouses = Array.from(spouseIds).map(id => personsData.find(p => p.id === id)).filter(p => p);

      let html = '';
      html += `<div class="person-title">${escapeHtml(getFullName(person))}</div>`;

      // Parents row
      if (father || mother) {
        html += '<div class="row-label">Parents</div><div class="row">';
        if (father) html += renderCardHtml(father, false, personsData);
        if (mother) html += renderCardHtml(mother, false, personsData);
        html += '</div>';
      }

      // Siblings and spouses row
      html += '<div class="row-label">Siblings and Spouses</div><div class="row">';
      siblings.forEach(s => { html += renderCardHtml(s, false, personsData); });
      html += renderCardHtml(person, true, personsData);
      spouses.forEach(s => { html += renderCardHtml(s, false, personsData); });
      html += '</div>';

      // Children row
      if (children.length > 0) {
        html += '<div class="row-label">Children</div><div class="row">';
        children.forEach(c => { html += renderCardHtml(c, false, personsData); });
        html += '</div>';
      }

      // Bio section
      html += `<div class="bio-section">
        <div class="bio-label">BIO</div>
        <div class="bio-content">${escapeHtml(person.bio || 'No biography available.')}</div>
      </div>`;

      return html;
    }

    function renderCardHtml(person, isFocused, personsData) {
      const descCount = getDescendantCountForExport(person.id, personsData);
      const avatarClass = getAvatarClass(person.gender);
      const birthDate = formatBirthDate(person);

      // Use CSS class for avatar image (defined once in stylesheet) instead of inline base64
      const avatarImageClass = person.picture ? ` avatar-${person.id}` : '';
      const avatarContent = person.picture ? '' : getInitials(person);

      const cardContent = `
        <div class="avatar ${avatarClass}${avatarImageClass}">${avatarContent}</div>
        <div class="name">${escapeHtml(getFullName(person))}</div>
        ${birthDate ? `<div class="birth">${escapeHtml(birthDate)}</div>` : ''}
        ${person.birthPlace ? `<div class="place">${escapeHtml(person.birthPlace)}</div>` : ''}
        ${descCount > 0 ? `<div class="descendants">${descCount} descendants</div>` : ''}
      `;

      if (isFocused) {
        return `<div class="card focused">${cardContent}</div>`;
      } else {
        return `<a href="#p${person.id}"><div class="card">${cardContent}</div></a>`;
      }
    }

    function getDescendantCountForExport(personId, personsData) {
      const visited = new Set();
      const countDescendants = (id) => {
        if (visited.has(id)) return 0;
        visited.add(id);
        const children = personsData.filter(p => p.fatherId === id || p.motherId === id);
        let count = children.length;
        children.forEach(c => { count += countDescendants(c.id); });
        return count;
      };
      return countDescendants(personId);
    }

    function downloadHtml(content, filename) {
      const blob = new Blob([content], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ============================================
    // INDEXEDDB STORAGE
    // ============================================
    const DB_NAME = 'FamilyTreeDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'familyData';
    let db = null;

    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };

        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          if (!database.objectStoreNames.contains(STORE_NAME)) {
            database.createObjectStore(STORE_NAME, { keyPath: 'key' });
          }
        };
      });
    }

    function saveToIndexedDB() {
      if (!db) return;

      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);

      const data = {
        key: 'treeData',
        persons: persons,
        nextId: nextId,
        focusedPersonId: focusedPersonId,
        lastModified: lastModified
      };

      store.put(data);
    }

    function loadFromIndexedDB() {
      return new Promise((resolve, reject) => {
        if (!db) {
          resolve(null);
          return;
        }

        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get('treeData');

        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
      });
    }

    function clearIndexedDB() {
      return new Promise((resolve, reject) => {
        if (!db) {
          resolve();
          return;
        }

        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete('treeData');

        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve();
      });
    }

    function autoSave() {
      saveToIndexedDB();
    }

    // ============================================
    // CLEAR TREE DATA
    // ============================================
    async function clearTreeData() {
      if (persons.length === 0) return;

      const confirmed = confirm(
        'Are you sure you want to clear all family tree data?\n\n' +
        'A backup HTML file will be downloaded before clearing.'
      );

      if (!confirmed) return;

      // Export backup first
      const html = generateExportHtml(persons, focusedPersonId);
      downloadHtml(html, `FamilyTree_Backup_${formatDateTimeForFilename()}.html`);

      // Clear data
      persons = [];
      nextId = 1;
      focusedPersonId = null;

      // Clear from IndexedDB
      await clearIndexedDB();

      render();
    }

    function formatDateTimeForFilename() {
      const now = new Date();
      const yy = String(now.getFullYear()).slice(-2);
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      return `${yy}${month}${day}${hours}${minutes}${seconds}`;
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    async function init() {
      // First, check for embedded data (when opened as an exported file)
      const embeddedDataEl = document.getElementById('embeddedData');
      if (embeddedDataEl) {
        try {
          const embeddedData = JSON.parse(embeddedDataEl.textContent);
          if (embeddedData && embeddedData.persons && embeddedData.persons.length > 0) {
            persons = embeddedData.persons;
            nextId = embeddedData.nextId || (Math.max(...persons.map(p => p.id), 0) + 1);
            focusedPersonId = embeddedData.focusedPersonId || persons[0].id;
            lastModified = embeddedData.lastModified || null;

            // Hide the static view since JS is working
            const staticView = document.getElementById('staticView');
            if (staticView) staticView.style.display = 'none';

            // Show the app UI
            document.querySelector('.header').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'block';

            render();
            return;
          }
        } catch (e) {
          // No valid embedded data, continue to IndexedDB
        }
      }

      // Hide static view if present (we have JS)
      const staticView = document.getElementById('staticView');
      if (staticView) staticView.style.display = 'none';

      // Show the app UI
      document.querySelector('.header').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'block';

      try {
        await openDatabase();
        const savedData = await loadFromIndexedDB();

        if (savedData && savedData.persons && savedData.persons.length > 0) {
          persons = savedData.persons;
          nextId = savedData.nextId || (Math.max(...persons.map(p => p.id), 0) + 1);
          focusedPersonId = savedData.focusedPersonId || persons[0].id;
          lastModified = savedData.lastModified || null;
        }
      } catch (error) {
        console.error('Error loading from IndexedDB:', error);
      }

      render();
    }

    init();
  </script>
</body>
</html>
